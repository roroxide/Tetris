(function(a){jQuery.fn.tetrisSetup=function(b){var c=jQuery.extend({boardWidth:15,boardHeight:20,boardColor:"#aaf",boardBorder:"1px solid green",fallSpeed:0,cellWidth:12},b);jQuery.fn.myOptions=c;a('<div id="tetrisBoard" style="position:absolute;display:none;left:0;top:0;"></div>').css("width",c.cellWidth*c.boardWidth+"px").css("height",c.cellWidth*c.boardHeight+"px").css("background-color",c.boardColor).css("border",c.boardColor).css("overflow","hidden").appendTo(a(this));for(var d=0;d<c.boardHeight;d++){for(var e=0;e<c.boardWidth;e++){a('<div class="tetrisbox" id="tetrisbox'+(d*c.boardWidth+e)+'" style="position:absolute;display:none;"></div>').css("left",e*c.cellWidth+"px").css("top",d*c.cellWidth+"px").css({border:"1px solid #000","background-color":"yellow"}).css("width",c.cellWidth-2+"px").css("height",c.cellWidth-2+"px").appendTo("#tetrisBoard")}}a('<div id="tetrisScore" style="font-weight:bold;font-family:arial;position:absolute;left:0;height:20px;text-align:center;">Score : 0</div>').css("width",c.cellWidth*c.boardWidth+"px").css("background-color","#ddd").css("top",(c.cellWidth+1)*c.boardHeight+"px").appendTo(a(this));a('<div id="tetrisNext" style="position:absolute;top:0;"></div>').css("left",c.cellWidth*c.boardWidth+10+"px").css("width",c.cellWidth*4+"px").css("height",c.cellWidth*4+"px").css("background-color","#faf").appendTo(a(this));for(var d=0;d<4;d++){for(var e=0;e<4;e++){a('<div class="tetrisnext" id="tetrisnext'+(d*4+e)+'" style="position:absolute;display:none;"></div>').css("left",e*c.cellWidth+"px").css("top",d*c.cellWidth+"px").css({border:"1px solid #000","background-color":"yellow"}).css("width",c.cellWidth-2+"px").css("height",c.cellWidth-2+"px").appendTo("#tetrisNext")}}a('<div id="tetrisHelp" style="position:absolute; text-align:left; padding:2px; background-color:#ffa">'+"use :<br/>"+"   <b>arrows</b> to move and rotate<br />"+"   <b>enter</b>/<b>space</b> to fall down,<br />"+"   <b>t</b> to try again,<br />"+"   <b>p</b> to pause and continue."+"</div>").css("left",c.cellWidth*c.boardWidth+10+"px").css("top",c.cellWidth*4+10+"px").appendTo(a(this));var f=[];for(var g=0;g<jQuery.fn.tetrisShapes.length;g++){f=jQuery.fn.tetrisShapes[g].map.split("\n");for(var d=0;d<f.length;d++){r=-1;for(var e=0;e<f[d].length;e++){if(f[d].substr(e,1)=="o"){if(r==-1){jQuery.fn.tetrisShapes[g].lIndexes[jQuery.fn.tetrisShapes[g].lIndexes.length]=d*c.boardWidth+e-1}r=e;jQuery.fn.tetrisShapes[g].indexes[jQuery.fn.tetrisShapes[g].indexes.length]=d*c.boardWidth+e;if(d==f.length-1){jQuery.fn.tetrisShapes[g].dIndexes[jQuery.fn.tetrisShapes[g].dIndexes.length]=(d+1)*c.boardWidth+e}else if(e>=f[d+1].length){jQuery.fn.tetrisShapes[g].dIndexes[jQuery.fn.tetrisShapes[g].dIndexes.length]=(d+1)*c.boardWidth+e}else if(f[d+1].substr(e,1)==" "){jQuery.fn.tetrisShapes[g].dIndexes[jQuery.fn.tetrisShapes[g].dIndexes.length]=(d+1)*c.boardWidth+e}}}jQuery.fn.tetrisShapes[g].rIndexes[jQuery.fn.tetrisShapes[g].rIndexes.length]=d*c.boardWidth+r+1}}jQuery.fn.gameNo=0;a("#tetrisBoard").show()};jQuery.fn.updateScore=function(b){a("#tetrisScore").html("Score : "+b)};jQuery.fn.tetrisNewgame=function(){jQuery.fn.shape=null;jQuery.fn.nextshape=jQuery.fn.tetrisShapes[Math.floor(Math.random()*jQuery.fn.tetrisShapes.length)];jQuery.fn.shapeX=0;jQuery.fn.shapeY=0;jQuery.fn.shapeNo=0;jQuery.fn.shapeIndex=0;jQuery.fn.tetrisScore=0;jQuery.fn.tetrisHalt=false;jQuery.fn.tetrisPause=false;jQuery.fn.updateScore(0);a(".popupBoard").remove();a(".tetrisbox").hide();a(".tetrisnext").hide();jQuery.fn.gameNo++;jQuery.fn.popupCountDown()};jQuery.fn.tetrisStart=function(b){a("body").tetrisSetup(b);a(document).keydown(function(b){if(b.keyCode==84){jQuery.fn.tetrisPause=true;jQuery.fn.popupAbortGame()}if(b.keyCode==80){jQuery.fn.tetrisPause=!jQuery.fn.tetrisPause}if(b.keyCode==32||b.keyCode==13){a("#tetrisBoard").tetrisFallDown()}if(b.keyCode==38){a("#tetrisBoard").tetrisRotate()}if(b.keyCode==37){a("#tetrisBoard").tetrisMoveLeft()}if(b.keyCode==39){a("#tetrisBoard").tetrisMoveRight()}if(b.keyCode==40){a("#tetrisBoard").tetrisMoveDown()}});jQuery.fn.popupStartGame()};jQuery.fn.tetrisShape=function(){jQuery.fn.shape=jQuery.fn.nextshape;jQuery.fn.shapeX=Math.floor(Math.random()*(jQuery.fn.myOptions.boardWidth-jQuery.fn.shape.width));jQuery.fn.shapeY=0-jQuery.fn.shape.map.split("\n").length;jQuery.fn.shapeIndex=jQuery.fn.shapeY*jQuery.fn.myOptions.boardWidth+jQuery.fn.shapeX;jQuery.fn.nextshape=jQuery.fn.tetrisShapes[Math.floor(Math.random()*jQuery.fn.tetrisShapes.length)];jQuery.fn.tetrisRenderNext();jQuery.fn.shapeNo++;return this};jQuery.fn.tetrisDown=function(b){if(jQuery.fn.tetrisHalt||b<jQuery.fn.gameNo){return true}var c=jQuery.fn.tetrisMoveDown();if(c==false){if(jQuery.fn.shapeY<0){jQuery.fn.tetrisPause=true;jQuery.fn.tetrisHalt=true;jQuery.fn.popupGameOver()}var d=true;var e=0;for(var f=jQuery.fn.shapeY+jQuery.fn.shape.map.split("\n").length-1;f>=0;f--){if(f<jQuery.fn.shapeY&&e==0){break}d=false;if(jQuery.fn.shapeY<=f){d=true;for(var g=0;g<jQuery.fn.myOptions.boardWidth;g++){if(a("#tetrisbox"+(f*jQuery.fn.myOptions.boardWidth+g)).filter(":visible").length==0){d=false}}if(d==true){e++;jQuery.fn.tetrisScore++;jQuery.fn.updateScore(jQuery.fn.tetrisScore);jQuery.fn.myOptions.fallSpeed+=1}}if(d==false&&e>0){if(f<e){a("#tetrisbox"+(f*jQuery.fn.myOptions.boardWidth+g)).hide()}else{for(var g=0;g<jQuery.fn.myOptions.boardWidth;g++){if(a("#tetrisbox"+(f*jQuery.fn.myOptions.boardWidth+g)).filter(":visible").length==0){a("#tetrisbox"+((f+e)*jQuery.fn.myOptions.boardWidth+g)).hide()}else{a("#tetrisbox"+((f+e)*jQuery.fn.myOptions.boardWidth+g)).show()}}}}}a("#tetrisBoard").tetrisShape().tetrisDown(b)}else{setTimeout("jQuery.fn.tetrisDown("+b+")",1e3-10*jQuery.fn.myOptions.fallSpeed)}};jQuery.fn.tetrisFallDown=function(){if(jQuery.fn.tetrisPause){return true}var b=jQuery.fn.shapeY;var c=0;jQuery.fn.clearShape();while(b<jQuery.fn.myOptions.boardHeight-jQuery.fn.shape.map.split("\n").length){c=b*jQuery.fn.myOptions.boardWidth+jQuery.fn.shapeX;if(a(this).tetrisCheck(jQuery.fn.shape.dIndexes,c)==false){break}b++}jQuery.fn.shapeY=b;jQuery.fn.shapeIndex=jQuery.fn.shapeY*jQuery.fn.myOptions.boardWidth+jQuery.fn.shapeX;a(this).tetrisRender()};jQuery.fn.tetrisRenderNext=function(){a(".tetrisnext").hide();var b=jQuery.fn.nextshape.map.split("\n");var c=0;for(var d=0;d<b.length;d++){for(var e=0;e<b[d].length;e++){if(b[d].substr(e,1)=="o"){c=d*4+e;a("#tetrisnext"+c).show()}}}};jQuery.fn.tetrisRender=function(){for(var b=0;b<jQuery.fn.shape.indexes.length;b++){var c=jQuery.fn.shapeIndex+jQuery.fn.shape.indexes[b];if(c>=0){a("#tetrisbox"+c).show()}}};jQuery.fn.clearShape=function(){for(var b=0;b<jQuery.fn.shape.indexes.length;b++){var c=jQuery.fn.shapeIndex+jQuery.fn.shape.indexes[b];if(c>=0){a("#tetrisbox"+c).hide()}}};jQuery.fn.tetrisCheck=function(b,c){var d=0;var e=(jQuery.fn.myOptions.boardHeight+1)*jQuery.fn.myOptions.boardWidth;for(var f=0;f<b.length;f++){d=c+b[f];if(d>=0){if(a("#tetrisbox"+d).filter(":visible").length==1||a("#tetrisbox"+d).length==0){return false}}}return true};jQuery.fn.tetrisMoveRight=function(){if(jQuery.fn.tetrisPause){return true}if(jQuery.fn.shapeX<jQuery.fn.myOptions.boardWidth-jQuery.fn.shape.width){if(a(this).tetrisCheck(jQuery.fn.shape.rIndexes,jQuery.fn.shapeIndex)){jQuery.fn.clearShape();jQuery.fn.shapeX++;jQuery.fn.shapeIndex++;a(this).tetrisRender()}}};jQuery.fn.tetrisMoveLeft=function(){if(jQuery.fn.tetrisPause){return true}if(jQuery.fn.shapeX>0){if(a(this).tetrisCheck(jQuery.fn.shape.lIndexes,jQuery.fn.shapeIndex)){a(this).clearShape();jQuery.fn.shapeX--;jQuery.fn.shapeIndex--;a(this).tetrisRender()}}};jQuery.fn.tetrisRotate=function(){if(jQuery.fn.tetrisPause){return true}a(this).clearShape();var b=jQuery.fn.tetrisShapes[jQuery.fn.shape.rotate];if(a(this).tetrisCheck(b.indexes,jQuery.fn.shapeIndex)&&jQuery.fn.shapeX+b.width<=jQuery.fn.myOptions.boardWidth){jQuery.fn.shape=b}a(this).tetrisRender()};jQuery.fn.tetrisMoveDown=function(){if(jQuery.fn.tetrisPause){return true}if(jQuery.fn.shapeY<jQuery.fn.myOptions.boardHeight-jQuery.fn.shape.map.split("\n").length){if(a(this).tetrisCheck(jQuery.fn.shape.dIndexes,jQuery.fn.shapeIndex)){a(this).clearShape();jQuery.fn.shapeY++;jQuery.fn.shapeIndex=jQuery.fn.shapeY*jQuery.fn.myOptions.boardWidth+jQuery.fn.shapeX;a(this).tetrisRender();return true}}return false};jQuery.fn.popupGameOver=function(){a('<div class="popupBoard" style="z-index:10000;position:absolute;"></div>').css("background-color","gray").css("width",a("#tetrisBoard").css("width")).css("height",a("#tetrisBoard").css("height")).append('<div id="gameover" style="font-size: 22px; color:orange; padding-top:50px;'+' font-family: arial; direction:ltr;">Game Over!</div>').append('<div id="newgame" style="font-size: 22px; height:40px; cursor: pointer;'+"color:orange; padding-top:50px; text-decoration:underline;"+' font-family: arial">Try Again</div>').appendTo("#tetrisBoard");a("#newgame").click(function(){jQuery.fn.tetrisNewgame()})};jQuery.fn.popupAbortGame=function(){a('<div class="popupBoard" style="z-index:10000;position:absolute;"></div>').css("background-color","gray").css("width",a("#tetrisBoard").css("width")).css("height",a("#tetrisBoard").css("height")).append('<div id="continue" style="font-size: 22px; color:orange; padding-top:50px; cursor: pointer;'+' font-family: arial; direction:ltr; text-decoration:underline;">Continue >></div>').append('<div id="newgame" style="font-size: 22px; height:40px; cursor: pointer;'+"color:orange; padding-top:50px; text-decoration:underline;"+' font-family: arial">Try Again</div>').appendTo("#tetrisBoard");a("#newgame").click(function(){jQuery.fn.tetrisHalt=true;jQuery.fn.tetrisNewgame()});a("#continue").click(function(){a(".popupBoard").remove();jQuery.fn.tetrisPause=false})};jQuery.fn.popupStartGame=function(){a('<div class="popupBoard" style="z-index:10000;position:absolute;"></div>').css("background-color","gray").css("width",a("#tetrisBoard").css("width")).css("height",a("#tetrisBoard").css("height")).append('<div id="startgame" style="font-size: 22px; color:orange; padding-top:100px; cursor: pointer;'+' font-family: arial; direction:ltr; text-decoration:underline;">Start Game</div>').appendTo("#tetrisBoard");a("#startgame").click(function(){jQuery.fn.tetrisNewgame()})};jQuery.fn.popupCountDown=function(){a('<div class="popupBoard" style="z-index:10000;position:absolute;"></div>').css("background-color","gray").css("width",a("#tetrisBoard").css("width")).css("height",a("#tetrisBoard").css("height")).append('<div id="countdown" style="font-size: 22px; color:orange; padding-top:100px; cursor: pointer;'+' font-family: arial; direction:ltr;"></div>').appendTo("#tetrisBoard");a("#countdown").countDown(3)};jQuery.fn.countDown=function(b){if(b==0){a(".popupBoard").remove();a("#tetrisBoard").tetrisShape().tetrisDown(jQuery.fn.gameNo)}else{a(this).html(b);b--;setTimeout('$("#countdown").countDown('+b+")",1e3)}};jQuery.fn.tetrisShapes=[{rotate:1,width:4,map:"oooo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:0,width:1,map:"o\no\no\no",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:3,width:3,map:"oo\n oo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:2,width:2,map:" o\noo\no",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:5,width:3,map:" oo\noo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:4,width:2,map:"o\noo\n o",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:6,width:2,map:"oo\noo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:11,width:3,map:"o\nooo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:12,width:3,map:"  o\nooo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:13,width:3,map:"ooo\no",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:14,width:3,map:"ooo\n  o",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:10,width:2,map:" o\n o\noo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:9,width:2,map:"o\no\noo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:8,width:2,map:"oo\n o\n o",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:7,width:2,map:"oo\no\no",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:16,width:3,map:" o\nooo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:17,width:2,map:" o\noo\n o",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:18,width:3,map:"ooo\n o",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:15,width:2,map:"o\noo\no",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:22,width:2,map:"oo\no\noo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:19,width:3,map:"ooo\no o",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:20,width:2,map:"oo\n o\noo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:21,width:3,map:"o o\nooo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:24,width:3,map:"oo\n o\n oo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:23,width:3,map:"  o\nooo\no",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:26,width:3,map:" oo\n o\noo",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:25,width:3,map:"o\nooo\n  o",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]},{rotate:27,width:3,map:" o\nooo\n o",indexes:[],lIndexes:[],rIndexes:[],dIndexes:[]}]})(jQuery)